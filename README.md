[![C#](https://img.shields.io/badge/C%23-%2300599C.svg?style=for-the-badge&logo=c-sharp&logoColor=white)](https://docs.microsoft.com/en-us/dotnet/csharp/) ![.NET Badge](https://img.shields.io/badge/.NET-512BD4?logo=dotnet&logoColor=fff&style=for-the-badge) ![Docker Badge](https://img.shields.io/badge/Docker-2496ED?logo=docker&logoColor=fff&style=for-the-badge) ![Grafana Badge](https://img.shields.io/badge/Grafana-F46800?logo=grafana&logoColor=fff&style=for-the-badge) ![InfluxDB Badge](https://img.shields.io/badge/InfluxDB-22ADF6?logo=influxdb&logoColor=fff&style=for-the-badge)

# SyftGrypeVulnarabilityScanner

Retreives the results of a Syft/Grype container/dependency vulnerability scan from a build artifact in Azure DevOps and pushes this to a InFluxDB bucket. This also includes a Grafana dashboard definition to display these vulnerabilities.

## Prerequisites

1. **Install .NET SDK**:
   - Ensure you have the .NET SDK installed on your machine. You can download it from the [.NET download page](https://dotnet.microsoft.com/download).

2. **Verify Installation**:
   - Open a terminal or command prompt and run the following command to verify the installation:
     ```sh
     dotnet --version
     ```
   - This should output the version of the .NET SDK installed.

### Docker

Docker is required to run the Syft/Grype container scans. Follow the steps below to install Docker on your system.

#### Install Docker on Windows

1. **Download Docker Desktop**: Visit the [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop) page and download the installer.
2. **Run the Installer**: Follow the on-screen instructions to complete the installation.
3. **Verify Installation**: Open PowerShell and run the following command to verify that Docker is installed correctly:

    ```powershell
    docker --version
    ```

Alternatively, you can install Docker using PowerShell:

1. **Open PowerShell as Administrator**: Right-click on the PowerShell icon and select "Run as administrator".
2. **Run the Installation Command**: Execute the following command to install Docker:

    ```powershell
    Invoke-WebRequest -Uri https://desktop.docker.com/win/stable/Docker%20Desktop%20Installer.exe -OutFile DockerDesktopInstaller.exe
    Start-Process -FilePath .\DockerDesktopInstaller.exe -ArgumentList "/quiet", "/norestart" -Wait
    Remove-Item -Force DockerDesktopInstaller.exe
    ```

3. **Start Docker Desktop**: After installation, start Docker Desktop from the Start menu.
4. **Verify Installation**: Run the following command to verify that Docker is installed correctly:

    ```powershell
    docker --version
    ```

For more detailed instructions, refer to the [official Docker documentation](https://docs.docker.com/get-docker/).

## Get Started (local machine)
1. **Start the Containers**: Open a terminal in your project directory and run the following command to start the InfluxDB and Grafana containers:

    ```powershell
    docker-compose up -d
    ```

    The `-d` flag runs the containers in detached mode.

2. **Access InfluxDB and Grafana**:
    - **InfluxDB**: Open your browser and go to `http://localhost:8086` to access the InfluxDB UI.
    - **Grafana**: Open your browser and go to `http://localhost:3000` to access the Grafana UI. Log in with the credentials specified in the [`docker-compose.yml`](command:_github.copilot.openSymbolFromReferences?%5B%22docker-compose.yml%22%2C%5B%7B%22uri%22%3A%7B%22%24mid%22%3A1%2C%22fsPath%22%3A%22d%3A%5C%5Cprojects%5C%5CSyftGrypeScraper%5C%5CREADME.md%22%2C%22_sep%22%3A1%2C%22external%22%3A%22file%3A%2F%2F%2Fd%253A%2Fprojects%2FSyftGrypeScraper%2FREADME.md%22%2C%22path%22%3A%22%2FD%3A%2Fprojects%2FSyftGrypeScraper%2FREADME.md%22%2C%22scheme%22%3A%22file%22%7D%2C%22pos%22%3A%7B%22line%22%3A28%2C%22character%22%3A43%7D%7D%2C%7B%22uri%22%3A%7B%22%24mid%22%3A1%2C%22fsPath%22%3A%22d%3A%5C%5Cprojects%5C%5CSyftGrypeScraper%5C%5CREADME.md%22%2C%22_sep%22%3A1%2C%22external%22%3A%22file%3A%2F%2F%2Fd%253A%2Fprojects%2FSyftGrypeScraper%2FREADME.md%22%2C%22path%22%3A%22%2FD%3A%2Fprojects%2FSyftGrypeScraper%2FREADME.md%22%2C%22scheme%22%3A%22file%22%7D%2C%22pos%22%3A%7B%22line%22%3A0%2C%22character%22%3A321%7D%7D%5D%5D "Go to definition") file.

For more detailed instructions on using Docker Compose, refer to the [official Docker Compose documentation](https://docs.docker.com/compose/).

## Set up Azure DevOps
The actual creation of the of the vulnerability scanning of all dependencies is done in Azure DevOps. There need to be one or more pipelines that perform the scan using Syft and Grype. An example of a pipeline can be found here:

```yaml
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  CONTAINER_IMAGE: '[your_container_registry].azurecr.io/storyteq:latest'

jobs:
- job: ScanContainer
  displayName: 'Scan Container for Vulnerabilities'
  steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: '[your_service_connection]'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Installing Syft"
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

        echo "Installing Grype"
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
    displayName: 'Install Syft and Grype'

  - task: AzureCLI@2
    inputs:
      azureSubscription: '[your_service_connection]'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Logging into Azure Container Registry"
        az acr login --name [your_container_registry]
    displayName: 'Login to Azure Container Registry'

  - task: AzureCLI@2
    inputs:
      azureSubscription: '[your_service_connection]'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Generating SBOM with Syft"
        syft $CONTAINER_IMAGE -o json > sbom.json
    displayName: 'Generate SBOM with Syft'

  - task: AzureCLI@2
    inputs:
      azureSubscription: '[your_service_connection]'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Scanning for vulnerabilities with Grype"
        grype sbom:sbom.json
        # Save results in JSON format
        grype sbom:sbom.json -o json > grype-scan-results.json
    displayName: 'Scan for Vulnerabilities with Grype'
  
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: 'grype-scan-results.json'
      ArtifactName: 'GrypeScanResults'
      publishLocation: 'Container'
    displayName: 'Publish Grype Scan Results as Build Artifact'
```

> ⚠️ **NOTICE** That the name of this pipeline must correspond with the postfix as configured in the appsettings.json. You can create as many pipelines for different services as needed as long as the postfix corresponds the results wil be picked up and pushed to Influx and eventualy displayed in grafana.

Once this is done, this app needs to able to access the Azure DevOps api's. Therefor you need to create a PAT token in Azure DevOps. 

### Creating a Personal Access Token (PAT) in Azure DevOps

A Personal Access Token (PAT) is required to authenticate and access Azure DevOps APIs. Follow the steps below to create a PAT:

#### Step-by-Step Guide

1. **Sign in to Azure DevOps**:
   - Go to [Azure DevOps](https://dev.azure.com/) and sign in with your account.

2. **Navigate to User Settings**:
   - Click on your profile picture in the top right corner.
   - Select **"Security"** from the dropdown menu.

3. **Create a New Token**:
   - In the **"Personal Access Tokens"** section, click on **"New Token"**.

4. **Configure the Token**:
   - **Name**: Enter a descriptive name for the token (e.g., "SyftGrypeScraper Access Token").
   - **Organization**: Select the organization for which the token will be used.
   - **Scopes**: Choose the scopes required for your application. For accessing build artifacts and pipelines, you typically need:
     - **Build (Read)**: To read build information.
     - **Artifacts (Read)**: To read artifacts.
     - **Project and Team (Read)**: To read project and team information.
   - **Expiration**: Set the expiration date for the token. Choose a duration that balances security and convenience.

5. **Create the Token**:
   - Click on **"Create"** to generate the token.

6. **Copy the Token**:
   - **Important**: Copy the token and store it securely. You will not be able to see the token again once you close the window.
   - Use this token in your application to authenticate API requests.

#### Example Usage in `appsettings.json`

Add the PAT token to your `appsettings.json` file:

```json
{
  "AzureDevOps": {
    "Org": "your_organization",
    "Project": "your_project",
    "Pat": "your_pat_token",
    "ApiVersion": "6.0",
    "PipelinePostfix": "your_pipeline_postfix"
  },
  "InfluxDb": {
    "Url": "http://localhost:8086",
    "Token": "your_influxdb_token",
    "Org": "your_influxdb_org",
    "Bucket": "your_influxdb_bucket"
  }
}
```

## Setup InfluxDB

### Step-by-Step Guide

1. **Access InfluxDB UI**:
   - Open your web browser and go to `http://localhost:8086`.

2. **Sign In**:
   - Sign in with your InfluxDB credentials.

3. **Create a Bucket**:
   - Navigate to the **"Buckets"** section in the left-hand menu.
   - Click on **"Create Bucket"**.
   - **Name**: Enter a name for your bucket (e.g., "GrypeScanResults").
   - **Retention Rules**: Set the retention period for the data in the bucket. You can choose a specific duration or keep it as "Infinite".
   - Click on **"Create"** to create the bucket.

4. **Create a Token**:
   - Navigate to the **"Tokens"** section in the left-hand menu.
   - Click on **"Generate Token"** and select **"Read/Write Token"**.
   - **Description**: Enter a description for the token (e.g., "GrypeScanResults Token").
   - **Bucket Permissions**: Select the bucket you created (e.g., "GrypeScanResults") and set the permissions to **Read/Write**.
   - Click on **"Save"** to generate the token.
   - **Important**: Copy the token and store it securely. You will not be able to see the token again once you close the window.

### Example Usage in `appsettings.json`

Add the InfluxDB URL, token, organization, and bucket to your `appsettings.json` file:

```json
{
  "AzureDevOps": {
    "Org": "your_organization",
    "Project": "your_project",
    "Pat": "your_pat_token",
    "ApiVersion": "6.0",
    "PipelinePostfix": "your_pipeline_postfix"
  },
  "InfluxDb": {
    "Url": "http://localhost:8086",
    "Token": "your_influxdb_token",
    "Org": "your_influxdb_org",
    "Bucket": "GrypeScanResults"
  }
}
```

## Setup .NET Console Application

### Step-by-Step Guide

1. **Navigate to the Project Directory**:
   - Open a terminal or command prompt.
   - Navigate to the directory containing your .NET project. For example:
     ```sh
     cd path/to/your/project
     ```

2. **Run the Application**:
   - Use the `dotnet run` command to run the application:
     ```sh
     dotnet run
     ```

### Example Output

When you run the application, you should see output similar to the following:

```sh
Pipeline: Service-******* VulnerabilityScan, Latest Build Number: *****
Writing vulnerability GHSA-m5vv-6r4h-3vj9 to InfluxDB
Writing vulnerability GHSA-x674-v45j-fwxw to InfluxDB
Writing vulnerability GHSA-59j7-ghrg-fj52 to InfluxDB
Writing vulnerability GHSA-6qmf-mmc7-6c2p to InfluxDB
Writing vulnerability GHSA-g3q9-xf95-8hp5 to InfluxDB
```


## Setup Grafana
### Step-by-Step Guide

#### 1. Create a Personal Access Token (PAT) in InfluxDB

1. **Access InfluxDB UI**:
   - Open your web browser and go to `http://localhost:8086`.

2. **Sign In**:
   - Sign in with your InfluxDB credentials.

3. **Create a Token**:
   - Navigate to the **"Tokens"** section in the left-hand menu.
   - Click on **"Generate Token"** and select **"Read/Write Token"**.
   - **Description**: Enter a description for the token (e.g., "Grafana Access Token").
   - **Bucket Permissions**: Select the bucket you want to use (e.g., "GrypeScanResults") and set the permissions to **Read/Write**.
   - Click on **"Save"** to generate the token.
   - **Important**: Copy the token and store it securely. You will not be able to see the token again once you close the window.

#### 2. Add InfluxDB as a Data Source in Grafana

1. **Add Data Source**:
   - In Grafana, click on the **"Configuration"** (gear icon) in the left-hand menu.
   - Select **"Data Sources"**.
   - Click on **"Add data source"**.

2. **Configure InfluxDB Data Source**:
   - Select **"InfluxDB"** from the list of data sources.
   - **HTTP**:
     - **URL**: `http://influxdb:8086`
   - **Auth**:
     - **Token**: Paste the PAT token you generated in InfluxDB.
   - **InfluxDB Details**:
     - **Organization**: Enter your InfluxDB organization name.
     - **Bucket**: Enter the bucket name (e.g., "GrypeScanResults").
   - Click on **"Save & Test"** to verify the connection.

#### 3. Import Dashboard from JSON
![Grafana Dashboard Screenshot](GrafanaDashboard/Screenshot.png)
1. **Import Dashboard**:
   - In Grafana, click on the **"+"** icon in the left-hand menu and select **"Import"**.
   - **Upload JSON File**:
     - Click on **"Upload JSON file"** and select the [`GrafanaDashboard/Dashboard.json`](command:_github.copilot.openRelativePath?%5B%7B%22scheme%22%3A%22file%22%2C%22authority%22%3A%22%22%2C%22path%22%3A%22%2FD%3A%2Fprojects%2FSyftGrypeScraper%2FGrafanaDashboard%2FDashboard.json%22%2C%22query%22%3A%22%22%2C%22fragment%22%3A%22%22%7D%2C%22b59fa1ca-b8e7-4408-a944-d345725d19b5%22%5D "d:\projects\SyftGrypeScraper\GrafanaDashboard\Dashboard.json") file from your project directory.
   - **Load**:
     - Click on **"Load"** to load the dashboard configuration.
   - **Select Data Source**:
     - Select the InfluxDB data source you configured earlier.
   - Click on **"Import"** to add the dashboard.


## Deploy container Image to Azure 

param location string
param environmentName string
param containerAppName string

sqlite3 grafana.db 'PRAGMA journal_mode=wal;'



# Build the Docker image
az acr login --name acrshnmisc
docker build -t syftgrypescraper/syftgrypescraper:latest .
docker tag syftgrypescraper/syftgrypescraper acrshnmisc.azurecr.io/syftgrypescraper
docker push acrshnmisc.azurecr.io/syftgrypescraper
https://blog.rishabkumar.com/grafana-on-azure-web-app-containers#heading-initiate-an-empty-sqlite-database

az deployment group create  --name deploygrafana  --resource-group rg-shn-services-dev --template-file .\containerapp.bicep --parameters location='West Europe' environmentName=dev containerAppNameGrafana=grafanacontainerapp containerAppNameInflux=influxcontainerapp containerAppNameSyfteGrypeScraper=syftgrypescrapercontainerjob containerregistry=acrshnmisc



# Push the image to your container registry
docker push acrshnmisc/grafana-mssql

az deployment group create  --name deploygrafana  --resource-group rg-shn-services-dev --template-file .\containerapp.bicep --parameters location='West Europe' environmentName=dev containerAppName=grafanacontainerapp



## Summary

By following these steps, you will have set up AzureDevOps with vulnerability scanners, psuh this data to InfluxDB, and setup Grafana on `localhost:3000`, created a PAT in InfluxDB, added InfluxDB as a data source in Grafana, and imported a dashboard from a JSON file.

